<html>

<head>
    <style>
        .canvas {
            width: 100%;
            height: 100%;
        }

        .video {
            width: 800px;
            height: 500px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>

<body>

    <video class='video' autoplay playsinline muted ></video>

    <div id='debug'></div>

    <script>
        const peerRTCConfig = {
            'RTCIceServers': [{
                'url': 'stun:stun.l.google.com:19302'
            }]
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        const signalServerURL = window.location.hostname == 'localhost' ?
            "ws://localhost:9091" : "wss://grepawk.com/signal";
        const start = new Date().getTime();
        const channelName = window.location.search

        function debug(msg, obj) {
            const t = new Date().getTime() - start;
            $("#debug").append("<br>t" + t + ": " + msg);
            if (obj) $("#debug").append((JSON.stringify(obj).replace("\r\n", "<br>")));
        }

        $(document).ready(function () {
            let clientCon;
            var signalConn = new WebSocket(signalServerURL);
            signalConn.onopen = function (e) {
                signalConn.send(JSON.stringify({
                    type: "watch_stream",
                    channel: getUrlParameter("channel") || "default"
                }))
                signalConn.onmessage = function (event) {
                    let data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'offer':
                            debug("got offer")
                            gotSDP(data.offer, data.host_uuid);
                            break;
                        case 'candidate':
                            debug("got candidate");
                            clientCon.addIceCandidate(data.candidate);
                        default:
                            break;
                    }
                }
            }


            async function gotSDP(offer, host_uuid) {
                clientCon = new RTCPeerConnection(peerRTCConfig);
                const remoteVideo = document.getElementsByTagName("video")[0];
                clientCon.onicecandidate = (e) => {
                    debug("client on ice candidate ", e);
                    if (e.candidate) {
                        signalConn.send(JSON.stringify({
                            type: "candidate",
                            to_uuid: host_uuid,
                            candidate: e.candidate
                        }))
                    }
                }

                clientCon.ontrack = (e) => {
                    if (e.stream) {
                       debug("client got stream");

                        remoteVideo.srcObject = e.stream;
                    } else if (e.track) {
                        debug("client got track");
                        let remoteVideoStream = new MediaStream();
                        remoteVideoStream.addTrack(e.track);
                        remoteVideo.srcObject = remoteVideoStream;
                    } else {
                        debug("client on tracks but no stream", e);
                    }
                }

                debug("got sdp");

                await clientCon.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await clientCon.createAnswer();
                debug("setting answser");
                clientCon.setLocalDescription(answer);
                signalConn.send(JSON.stringify({
                            type: "answer",
                            to_uuid: host_uuid,
                            answer: answer
                        }))
                debug("host remote desc set");
            }
        })
    </script>
</body>

</html>