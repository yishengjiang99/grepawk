<html>

<body>
  <div class='container'>
    <h5>click pies</h5>
    <div id='msg'></div>
    <div id='pictures'></div>
  </div>
</body>
<script>
  const msgDiv = document.getElementById("msg");
  const pictureDiv = document.getElementById("pictures");
  const imgUrl = "https://xtima6ctq9.execute-api.us-east-1.amazonaws.com/dev/";

  function loadImage(url) {
    return new Promise(async (resolve, reject) => {
      try {
        const resp = await fetch(url);
        const json = await resp.json();
        if (!json.imageUrl) reject(new Error("api error"));
        resolve(json.imageUrl);
      } catch (e) {
        reject(e);
      }
    });
  }

  function renderImage(id, url) {
    console.log("loading " + url);
    const img = new Image(100, 100);
    img.src = url;
    img.id = id;
    pictureDiv.appendChild(img);

  }

  var images = [];

  function loadTest() {
    images = [];
    pictureDiv.innerHTML = "";
    msgDiv.innerHTML = "";
    for (let i = 0; i < 6; i++) {
      loadImage(imgUrl).then(url => {
        images.push(url);
        renderImage(i, url)
      }).catch(console.log);
    }
  }



  const serverurl = "http://localhost:8080?img=";

  var numWrong = 0;

  pictureDiv.addEventListener("click", function (e) {
    const id = e.target.id;
    const imageClicked = images[id];
    fetch(serverurl + imageClicked).then(res => res.json()).then(result => {
      if (result.isPie === false) {
        numWrong++;
        msgDiv.innerHTML = "Wrong! num wrong=" + numWrong;
        if (numWrong >= 3) {
          loadTest();
        }
      } else {
        msgDiv.innerHTML = "correct!";
        numWrong = 0;
      }
    });
  });

  loadTest();
</script>

</html>